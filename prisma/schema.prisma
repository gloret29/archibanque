generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  roles     Role[]
  groups    Group[]
  
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  users       User[]
  
  @@map("roles")
}

model Group {
  id          String   @id @default(uuid())
  name        String   @unique
  members     User[]
  
  @@map("groups")
}

// Enterprise Architecture Models
model ModelPackage {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  folders     Folder[]
  elements    ArchiElement[]
  views       ArchiView[]
  relations   ArchiRelation[]
  
  @@map("model_packages")
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  type        String   // 'folder' | 'view-folder' | 'element-folder'
  parentId    String?
  parent      Folder?  @relation("FolderToFolder", fields: [parentId], references: [id])
  children    Folder[] @relation("FolderToFolder")
  
  packageId   String
  package     ModelPackage @relation(fields: [packageId], references: [id])
  
  views       ArchiView[]
  elements    ArchiElement[]
  relations   ArchiRelation[]
  
  @@map("folders")
}

model ArchiElement {
  id            String   @id @default(uuid())
  externalId    String?  // For import/export ArchiMate ID
  name          String
  type          String   // Concept type (e.g., 'business-process')
  description   String?  // RW - Short description
  documentation String?  // RW - Detailed documentation
  properties    Json?    // key-value pairs
  
  // Read-only metadata (system-generated)
  createdAt     DateTime @default(now())  // RO - Creation timestamp
  modifiedAt    DateTime @default(now()) @updatedAt       // RO - Last modification timestamp
  author        String?                   // RO - Creator user ID
  
  packageId     String
  package       ModelPackage @relation(fields: [packageId], references: [id])
  
  folderId      String?
  folder        Folder?      @relation(fields: [folderId], references: [id])

  // Relations where this is source
  outRels       ArchiRelation[] @relation("RelSource")
  // Relations where this is target
  inRels        ArchiRelation[] @relation("RelTarget")

  @@map("archi_elements")
}

model ArchiRelation {
  id          String   @id @default(uuid())
  type        String   // Relation type (e.g., 'composition')
  name        String?
  description   String?  // RW
  documentation String?  // RW
  
  sourceId    String
  source      ArchiElement @relation("RelSource", fields: [sourceId], references: [id])
  
  targetId    String
  target      ArchiElement @relation("RelTarget", fields: [targetId], references: [id])
  
  packageId   String
  package     ModelPackage @relation(fields: [packageId], references: [id])

  folderId    String?
  folder      Folder?      @relation(fields: [folderId], references: [id])

  properties  Json?

  // Read-only metadata
  createdAt     DateTime @default(now())
  modifiedAt    DateTime @default(now()) @updatedAt
  author        String?

  @@map("archi_relations")
}

model ArchiView {
  id          String   @id @default(uuid())
  name        String
  description   String?  // RW
  documentation String?  // RW
  layout      Json     // React Flow nodes and edges state
  
  // Lock fields for check-in / check-out
  lockedBy    String?  // User ID who has the lock
  lockedAt    DateTime?
  lockMessage String?  // Optional message when checking out
  
  // Read-only metadata
  createdAt     DateTime @default(now())
  modifiedAt    DateTime @default(now()) @updatedAt
  author        String?

  packageId   String
  package     ModelPackage @relation(fields: [packageId], references: [id])
  
  folderId    String?
  folder      Folder?      @relation(fields: [folderId], references: [id])

  @@map("archi_views")
}

// Custom Data Blocks for extending elements with custom attributes
model DataBlock {
  id          String   @id @default(uuid())
  name        String
  targetTypes String[] // Array of element/relation type IDs this block applies to
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  attributes  DataBlockAttribute[]
  
  @@map("data_blocks")
}

model DataBlockAttribute {
  id          String   @id @default(uuid())
  name        String   // Display name
  key         String   // Internal key (e.g., risk_level)
  type        String   // 'string' | 'number' | 'date' | 'enum'
  enumValues  String[] // Only for 'enum' type
  sortOrder   Int      @default(0)
  
  blockId     String
  block       DataBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)
  
  @@map("data_block_attributes")
}

// Global Application Settings
model AppSettings {
  id                  String   @id @default("global")
  enabledElementTypes String[] // Array of enabled element type IDs
  updatedAt           DateTime @updatedAt
  
  @@map("app_settings")
}

